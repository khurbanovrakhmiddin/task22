name: Telegram Build Notify

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: subosito/flutter-action@v2
    - run: flutter pub get
    - run: flutter build apk --release
    
    - name: Send to Telegram
      run: |
        # Проверяем секреты
        if [ -z "${{ secrets.TELEGRAM_BOT_TOKEN }}" ] || [ -z "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
          echo "Skipping Telegram - secrets not set"
          exit 0
        fi
        
        VERSION=$(grep 'version:' pubspec.yaml | cut -d' ' -f2)
        
        curl -s -X POST \
          "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendDocument" \
          -F chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
          -F document=@"build/app/outputs/flutter-apk/app-release.apk" \
          -F caption="New build v$VERSION"
