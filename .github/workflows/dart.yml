name: Build and Notify

on:
  push:
    branches: [ main ]

jobs:
  build-and-notify:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2

    - name: Install dependencies
      run: flutter pub get

    - name: Build APK
      run: flutter build apk --release --split-per-abi

    - name: Debug - Check secrets
      run: |
        echo "Checking secrets..."
        echo "TELEGRAM_BOT_TOKEN exists: ${{ secrets.TELEGRAM_BOT_TOKEN != '' }}"
        echo "TELEGRAM_CHAT_ID exists: ${{ secrets.TELEGRAM_CHAT_ID != '' }}"

    - name: Send to Telegram
      if: secrets.TELEGRAM_BOT_TOKEN != '' && secrets.TELEGRAM_CHAT_ID != ''
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        echo "Sending APK to Telegram..."
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–µ—Ä—Å–∏–∏
        VERSION=$(grep 'version:' pubspec.yaml | cut -d' ' -f2)
        COMMIT_MSG="${{ github.event.head_commit.message }}"
        
        for apk in build/app/outputs/flutter-apk/*.apk; do
          echo "üì§ Sending $apk"
          curl -s -X POST \
            "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendDocument" \
            -F chat_id="$TELEGRAM_CHAT_ID" \
            -F document=@"$apk" \
            -F caption="üöÄ New Build v$VERSION

üì± Branch: ${{ github.ref_name }}
üìÖ Date: $(date +'%Y-%m-%d %H:%M')
üîó Commit: $COMMIT_MSG

Built with GitHub Actions" \
            && echo "‚úÖ File sent successfully" \
            || echo "‚ùå Failed to send file"
        done

    - name: Notify if no secrets
      if: secrets.TELEGRAM_BOT_TOKEN == '' || secrets.TELEGRAM_CHAT_ID == ''
      run: |
        echo "‚ö†Ô∏è Telegram secrets not configured"
        echo "Please set TELEGRAM_BOT_TOKEN and TELEGRAM_CHAT_ID in repository secrets"
