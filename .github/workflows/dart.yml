name: Build and Telegram Notify

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2

    - name: Install dependencies
      run: flutter pub get

    - name: Build APK
      run: flutter build apk --release

    - name: Send Telegram Notification
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          ğŸš€ New Build Completed!
          
          ğŸ“± Repository: ${{ github.repository }}
          ğŸŒ¿ Branch: ${{ github.ref_name }}
          ğŸ“ Commit: ${{ github.event.head_commit.message }}
          ğŸ‘¤ Author: ${{ github.event.head_commit.author.name }}
          
          âœ… APK built successfully!
        format: markdown

    - name: Upload APK to Telegram
      if: ${{ secrets.TELEGRAM_BOT_TOKEN != '' && secrets.TELEGRAM_CHAT_ID != '' }}
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        VERSION=$(grep 'version:' pubspec.yaml | cut -d' ' -f2)
        curl -F chat_id="$TELEGRAM_CHAT_ID" \
             -F document=@"./build/app/outputs/flutter-apk/app-release.apk" \
             -F caption="ğŸ“¦ APK v$VERSION" \
             "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendDocument"
